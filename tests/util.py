import contextlib
import os
import pathlib
import shlex
import subprocess
from typing import Iterator

from pytest_cookies.plugin import Result


@contextlib.contextmanager
def inside_directory_of(result: Result) -> Iterator[None]:
    old_dir = pathlib.Path.cwd()
    os.chdir(result.project_path)
    try:
        yield
    finally:
        os.chdir(old_dir)


def check_output_in_result_dir(command: str, result: Result) -> str:
    """Run the given command in the directory of `result`.

    The `command` parameter should be a string, while `result` is the
    object generated by the `cookies` PyTest fixture, an object of type
    `pytest_cookies.Result`.
    If the command returns with a non-zero code, this function raises an
    exception.

    Returns the combined stdout and stderr outputs.
    """
    with inside_directory_of(result):
        output = subprocess.check_output(
            shlex.split(command), stderr=subprocess.STDOUT
        )
    return str(output)
